{% extends "base.html" %}
{% block title %}Home - Web AI{% endblock %}
{% load static %}
{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
        font-family: 'Inter', sans-serif;
    }

    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .scan-animation {
        animation: scan 2s ease-in-out infinite;
    }

    @keyframes scan {

        0%,
        100% {
            transform: translateX(-100%);
        }

        50% {
            transform: translateX(100%);
        }
    }

    .result-card {
        transform: translateY(20px);
        opacity: 0;
        animation: slideUp 0.5s ease-out forwards;
    }

    @keyframes slideUp {
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .pulse-dot {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .tab-content {
        min-height: 400px;
    }

    .scanner-input:focus {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        border-color: #667eea;
    }

    .feature-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
</head>

<body class="bg-gray-50">
    <section class="gradient-bg text-white py-20">
        <div class="container mx-auto px-4 text-center">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-5xl md:text-6xl font-bold mb-6 animate-fade-in">
                    <i class="fas fa-search mr-4"></i>
                    Công cụ Quét Bảo mật
                </h1>
                <p class="text-xl md:text-2xl mb-8 opacity-90">
                    Phát hiện và giám sát các trang web lừa đảo, phishing với công nghệ AI tiên tiến
                </p>
                <div class="flex flex-wrap justify-center gap-6 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>Quét thời gian thực</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt mr-2"></i>
                        <span>Bảo mật cao</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-bolt mr-2"></i>
                        <span>Kết quả nhanh chóng</span>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <main class="container mx-auto px-4 py-12">
        <div class="bg-base-200 p-6 rounded-xl shadow-md mt-12">
            <!-- Tab Navigation -->
            <div role="tablist" class="tabs tabs-boxed justify-center mb-8">
                <button type="button" class="tab tab-lg" role="tab" data-tab-target="url" aria-controls="panel-url"
                    aria-selected="true">
                    <i class="fas fa-globe mr-2"></i>
                    URL Scanner
                </button>
                <button type="button" class="tab tab-lg" role="tab" data-tab-target="email" aria-controls="panel-email"
                    aria-selected="false">
                    <i class="fas fa-envelope mr-2"></i>
                    Email Scanner
                </button>
                <button type="button" class="tab tab-lg" role="tab" data-tab-target="typo" aria-controls="panel-typo"
                    aria-selected="false">
                    <i class="fas fa-crosshairs mr-2"></i>
                    Typosquat Monitor
                </button>
                <button type="button" class="tab tab-lg" role="tab" data-tab-target="takedown"
                    aria-controls="panel-takedown" aria-selected="false">
                    <i class="fas fa-gavel mr-2"></i>
                    Takedown
                </button>
            </div>

            <!-- Tab Panels -->
            <div class="mt-8">
                <!-- Email Panel -->
                <div id="panel-email" role="tabpanel" data-tab-panel="email" class="tab-panel hidden">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold mb-4">
                            <i class="fas fa-envelope feature-icon mr-3"></i>
                            Quét Email Nghi ngờ
                        </h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Phân tích nội dung email, header và đính kèm để phát hiện các dấu hiệu lừa đảo.
                        </p>
                    </div>

                    <div class="max-w-4xl mx-auto">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div
                                class="card bg-base-100 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:-translate-y-2 fade-in">
                                <div class="card-body">
                                    <h3 class="card-title mb-4">
                                        <i class="fas fa-paste mr-2"></i>
                                        Dán nội dung email
                                    </h3>
                                    <textarea class="textarea textarea-bordered w-full h-64"
                                        placeholder="Dán toàn bộ nội dung email hoặc header vào đây..."
                                        id="emailContent"></textarea>
                                    <div class="card-actions justify-end mt-4">
                                        <button class="btn btn-primary" onclick="scanEmail()">
                                            <i class="fas fa-search mr-2"></i>
                                            Quét Email
                                        </button>
                                    </div>
                                </div>
                            </div>

                        <!-- Gmail inbox widget (compact) -->
                        <div class="mt-6">
                            {% if user.is_authenticated %}
                            <div class="card bg-base-100 shadow-md">
                                <div class="card-body">
                                    <h3 class="card-title mb-3"><i class="fas fa-inbox mr-2"></i> Hộp thư Gmail</h3>
                                    <div id="gmail-alerts"></div>
                                    <div class="flex items-center gap-3 mb-3">
                                        <button id="loadGmailBtn" class="btn btn-sm btn-primary">Tải hộp thư</button>
                                        <span class="text-sm text-gray-500">Hiển thị tối đa 25 thư gần nhất</span>
                                    </div>

                                    <div id="gmailMessages" class="space-y-2 max-h-56 overflow-auto"></div>

                                    <div id="gmailPreview" style="display:none; margin-top:12px;">
                                        <h4 class="text-lg font-semibold">Nội dung email</h4>
                                        <pre id="gmailEmailBody" style="white-space:pre-wrap; background:#f8f8f8; padding:10px; border-radius:6px;"></pre>
                                        <div class="mt-2"><button id="closeGmailPreview" class="btn btn-ghost btn-sm">Đóng</button></div>
                                    </div>
                                </div>
                            </div>

                            <script>
                                (function(){
                                    // Robust API helper: include credentials, handle non-JSON responses and HTTP errors
                                    const api = async (path, method='GET') => {
                                        try {
                                            const r = await fetch(path, {
                                                method,
                                                credentials: 'same-origin',
                                                headers: {
                                                    'X-Requested-With': 'XMLHttpRequest',
                                                    'Accept': 'application/json'
                                                }
                                            });

                                            // If status is 401/403, try to parse JSON for error details, otherwise return structured error
                                            if (!r.ok) {
                                                const ct = r.headers.get('Content-Type') || '';
                                                if (ct.includes('application/json')) {
                                                    const j = await r.json().catch(()=>null);
                                                    return { error: j?.error || (`HTTP ${r.status} ${r.statusText}`), status: r.status, ...(j || {}) };
                                                }
                                                const text = await r.text().catch(()=>null);
                                                return { error: `HTTP ${r.status} ${r.statusText}`, status: r.status, text };
                                            }

                                            // Try to parse JSON, but be tolerant to non-json success responses
                                            const ct = r.headers.get('Content-Type') || '';
                                            if (ct.includes('application/json')) {
                                                return await r.json();
                                            }
                                            const text = await r.text().catch(()=>null);
                                            return { error: 'Unexpected response format from server', text };
                                        } catch (err) {
                                            console.error('Gmail widget fetch error', err);
                                            return { error: err.message || String(err) };
                                        }
                                    };

                                    const loadBtn = document.getElementById('loadGmailBtn');
                                    const alerts = document.getElementById('gmail-alerts');
                                    const list = document.getElementById('gmailMessages');

                                    function showAlertHtml(html) {
                                        alerts.innerHTML = html;
                                    }

                                    function renderMessages(messages) {
                                        list.innerHTML = '';
                                        if (!messages || messages.length === 0) {
                                            list.innerHTML = '<div class="text-sm text-gray-500">Không có thư để hiển thị.</div>';
                                            return;
                                        }
                                        messages.forEach(m => {
                                            const item = document.createElement('div');
                                            item.className = 'p-2 border rounded';
                                            item.innerHTML = `
                                                <div class="font-semibold">${m.subject || '(Không tiêu đề)'}</div>
                                                <div class="text-xs text-gray-500">${m.from || ''} · ${m.date || ''}</div>
                                                <div class="mt-1 text-sm">${m.snippet || ''}</div>
                                                <div class="mt-2"><button class="btn btn-xs btn-outline gmailScanBtn" data-id="${m.id}">Quét</button></div>
                                            `;
                                            list.appendChild(item);
                                        });

                                        // attach handlers
                                        list.querySelectorAll('.gmailScanBtn').forEach(b => {
                                            b.addEventListener('click', async (e) => {
                                                const id = e.currentTarget.dataset.id;
                                                e.currentTarget.disabled = true; e.currentTarget.textContent = 'Đang quét...';
                                                const res = await api('{% url "email_scan:api_fetch_message" "MSGID" %}'.replace('MSGID', id));
                                                e.currentTarget.disabled = false; e.currentTarget.textContent = 'Quét';
                                                if (res.error) {
                                                    if (res.reauth_url) {
                                                        showAlertHtml(`<div class="text-red-600 mb-2">${res.error}</div><a class="btn btn-sm btn-warning" href="${res.reauth_url}">Kết nối lại Google</a>`);
                                                    } else {
                                                        showAlertHtml(`<div class="text-red-600">${res.error}</div><pre class="text-xs mt-2">${res.text ? escapeHtml(res.text) : ''}</pre>`);
                                                    }
                                                    return;
                                                }
                                                const bodyPre = document.getElementById('gmailEmailBody');
                                                if (res.html) {
                                                    if (typeof DOMPurify === 'undefined') {
                                                        const s = document.createElement('script');
                                                        s.src = 'https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js';
                                                        s.onload = () => { bodyPre.innerHTML = DOMPurify.sanitize(res.html); };
                                                        document.head.appendChild(s);
                                                    } else {
                                                        bodyPre.innerHTML = DOMPurify.sanitize(res.html);
                                                    }
                                                } else {
                                                    bodyPre.textContent = res.text || res.snippet || '(Không có nội dung)';
                                                }
                                                document.getElementById('gmailPreview').style.display = 'block';
                                            });
                                        });
                                    }

                                    function escapeHtml(s) {
                                        if (!s) return '';
                                        return s.replace(/[&<>"']/g, function (c) {
                                            return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];
                                        });
                                    }

                                    if (loadBtn) {
                                        loadBtn.addEventListener('click', async () => {
                                            loadBtn.disabled = true; loadBtn.textContent = 'Đang tải...';
                                            alerts.innerHTML = '';
                                            list.innerHTML = '';

                                            const data = await api('{% url "email_scan:api_list_messages" %}');

                                            loadBtn.disabled = false; loadBtn.textContent = 'Tải hộp thư';

                                            if (data.error) {
                                                // If backend provides a reauth_url, show reconnect button
                                                if (data.reauth_url) {
                                                    showAlertHtml(`<div class="text-red-600 mb-2">${escapeHtml(data.error)}</div><a class="btn btn-sm btn-warning" href="${data.reauth_url}">Kết nối lại Google</a>`);
                                                } else {
                                                    showAlertHtml(`<div class="text-red-600">${escapeHtml(data.error)}</div><pre class="text-xs mt-2">${data.text ? escapeHtml(String(data.text)) : ''}</pre>`);
                                                }
                                                console.warn('Gmail API list error', data);
                                                return;
                                            }

                                            // success: render messages
                                            renderMessages(data.messages || []);
                                        });
                                    }

                                    const closeBtn = document.getElementById('closeGmailPreview');
                                    if (closeBtn) closeBtn.addEventListener('click', ()=>{ document.getElementById('gmailPreview').style.display = 'none'; });
                                })();
                            </script>

                            {% else %}
                            <div class="card bg-base-100 shadow-md">
                                <div class="card-body">
                                    <h3 class="card-title mb-2"><i class="fas fa-inbox mr-2"></i> Hộp thư Gmail</h3>
                                    <p>Bạn chưa đăng nhập. Vui lòng <a href="{% url 'account_login' %}">đăng nhập</a> và kết nối Google để xem hộp thư.</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                            <div
                                class="card bg-base-100 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:-translate-y-2 fade-in">
                                <div class="card-body">
                                    <h3 class="card-title mb-4">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Chúng tôi kiểm tra
                                    </h3>
                                    <ul class="space-y-3">
                                        <li class="flex items-center">
                                            <i class="fas fa-check text-green-500 mr-3"></i>
                                            <span>Liên kết độc hại trong email</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-check text-green-500 mr-3"></i>
                                            <span>Header email giả mạo</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-check text-green-500 mr-3"></i>
                                            <span>Kỹ thuật social engineering</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-check text-green-500 mr-3"></i>
                                            <span>Tệp đính kèm nguy hiểm</span>
                                        </li>
                                        <li class="flex items-center">
                                            <i class="fas fa-check text-green-500 mr-3"></i>
                                            <span>Mẫu phishing phổ biến</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL Panel (default visible) -->
                <div id="panel-url" role="tabpanel" data-tab-panel="url" class="tab-panel">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold mb-4">
                            <i class="fas fa-globe feature-icon mr-3"></i>
                            Quét URL Nghi ngờ
                        </h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Nhập URL bạn muốn kiểm tra. Hệ thống sẽ phân tích và cung cấp báo cáo chi tiết về mức độ an
                            toàn.
                        </p>
                    </div>

                    <div class="max-w-2xl mx-auto">
                        <div class="flex gap-3 mb-6">
                            <input type="url" placeholder="https://example.com"
                                class="input input-bordered input-lg w-full scanner-input" id="urlInput"
                                aria-label="Nhập URL cần quét">
                            <button class="btn btn-primary btn-lg px-8" onclick="scanUrl()">
                                <i class="fas fa-search mr-2"></i>
                                Quét ngay
                            </button>
                        </div>

                        <div class="text-center mb-6">
                            <p class="text-sm text-gray-500 mb-2">Ví dụ nhanh:</p>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button class="btn btn-outline btn-sm"
                                    onclick="setExample('https://google.com')">google.com</button>
                                <button class="btn btn-outline btn-sm"
                                    onclick="setExample('https://facebook.com')">facebook.com</button>
                                <button class="btn btn-outline btn-sm"
                                    onclick="setExample('https://suspicious-site.com')">suspicious-site.com</button>
                            </div>
                        </div>

                        <div id="scanProgress" class="hidden mb-6">
                            <div class="card bg-blue-50 border border-blue-200">
                                <div class="card-body">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold">Đang quét...</h3>
                                        <div class="loading loading-spinner loading-md text-primary"></div>
                                    </div>
                                    <progress class="progress progress-primary w-full" id="progressBar" value="0"
                                        max="100"></progress>
                                    <p class="text-sm text-gray-600 mt-2" id="scanStatus">Khởi tạo quét...</p>
                                </div>
                            </div>
                        </div>

                        <div id="scanResults" class="hidden">
                            Results will be populated here
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6 mt-12">
                        <div class="card bg-gradient-to-br from-blue-50 to-blue-100 border-0">
                            <div class="card-body text-center">
                                <i class="fas fa-camera text-3xl text-blue-600 mb-4"></i>
                                <h3 class="card-title justify-center">Screenshot</h3>
                                <p class="text-sm">Chụp ảnh màn hình trang web để phân tích giao diện</p>
                            </div>
                        </div>
                        <div class="card bg-gradient-to-br from-green-50 to-green-100 border-0">
                            <div class="card-body text-center">
                                <i class="fas fa-certificate text-3xl text-green-600 mb-4"></i>
                                <h3 class="card-title justify-center">SSL Certificate</h3>
                                <p class="text-sm">Kiểm tra chứng chỉ SSL và mức độ bảo mật</p>
                            </div>
                        </div>
                        <div class="card bg-gradient-to-br from-purple-50 to-purple-100 border-0">
                            <div class="card-body text-center">
                                <i class="fas fa-code text-3xl text-purple-600 mb-4"></i>
                                <h3 class="card-title justify-center">DOM Analysis</h3>
                                <p class="text-sm">Phân tích cấu trúc DOM và mã nguồn</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typosquat Panel -->
                <div id="panel-typo" role="tabpanel" data-tab-panel="typo" class="tab-panel hidden">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold mb-4">
                            <i class="fas fa-crosshairs feature-icon mr-3"></i>
                            Giám sát Typosquat
                        </h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Theo dõi các domain tương tự thương hiệu của bạn và cảnh báo khi có domain nghi ngờ được
                            đăng ký.
                        </p>
                    </div>

                    <div class="max-w-3xl mx-auto">
                        <div
                            class="card bg-base-100 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:-translate-y-2 fade-in">
                            <div class="card-body">
                                <div class="flex gap-3 mb-6">
                                    <input type="text" placeholder="example.com"
                                        class="input input-bordered input-lg w-full" id="domainInput"
                                        aria-label="Nhập domain cần giám sát">
                                    <button class="btn btn-primary btn-lg px-8" onclick="monitorDomain()">
                                        <i class="fas fa-eye mr-2"></i>
                                        Giám sát
                                    </button>
                                </div>

                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 class="font-semibold mb-3">
                                            <i class="fas fa-list mr-2"></i>
                                            Các biến thể phổ biến
                                        </h3>
                                        <ul class="text-sm space-y-2">
                                            <li><i class="fas fa-dot-circle text-orange-500 mr-2"></i>Thay thế ký tự (o
                                                → 0)</li>
                                            <li><i class="fas fa-dot-circle text-orange-500 mr-2"></i>Thêm/bớt ký tự
                                            </li>
                                            <li><i class="fas fa-dot-circle text-orange-500 mr-2"></i>Hoán đổi vị trí
                                            </li>
                                            <li><i class="fas fa-dot-circle text-orange-500 mr-2"></i>Subdomain giả mạo
                                            </li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold mb-3">
                                            <i class="fas fa-bell mr-2"></i>
                                            Cảnh báo khi phát hiện
                                        </h3>
                                        <ul class="text-sm space-y-2">
                                            <li><i class="fas fa-dot-circle text-blue-500 mr-2"></i>Domain mới đăng ký
                                            </li>
                                            <li><i class="fas fa-dot-circle text-blue-500 mr-2"></i>Độ tương tự cao</li>
                                            <li><i class="fas fa-dot-circle text-blue-500 mr-2"></i>Hoạt động đáng ngờ
                                            </li>
                                            <li><i class="fas fa-dot-circle text-blue-500 mr-2"></i>Báo cáo chi tiết
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Takedown Panel -->
                <div id="panel-takedown" role="tabpanel" data-tab-panel="takedown" class="tab-panel hidden">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold mb-4">
                            <i class="fas fa-gavel feature-icon mr-3"></i>
                            Yêu cầu Takedown
                        </h2>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Gửi yêu cầu gỡ bỏ các trang web lừa đảo đã được xác nhận với bằng chứng chi tiết.
                        </p>
                    </div>

                    <div class="max-w-4xl mx-auto">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div
                                class="card bg-base-100 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:-translate-y-2 fade-in">
                                <div class="card-body">
                                    <h3 class="card-title text-red-700 mb-4">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        Báo cáo trang web độc hại
                                    </h3>
                                    <form class="space-y-4">
                                        <div>
                                            <label class="label">
                                                <span class="label-text">URL độc hại</span>
                                            </label>
                                            <input type="url" class="input input-bordered w-full"
                                                placeholder="https://malicious-site.com">
                                        </div>
                                        <div>
                                            <label class="label">
                                                <span class="label-text">Loại vi phạm</span>
                                            </label>
                                            <select class="select select-bordered w-full">
                                                <option>Phishing</option>
                                                <option>Malware</option>
                                                <option>Giả mạo thương hiệu</option>
                                                <option>Lừa đảo</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="label">
                                                <span class="label-text">Mô tả chi tiết</span>
                                            </label>
                                            <textarea class="textarea textarea-bordered w-full" rows="4"
                                                placeholder="Mô tả chi tiết về vi phạm..."></textarea>
                                        </div>
                                        <button type="button" class="btn btn-error w-full" onclick="submitTakedown()">
                                            <i class="fas fa-paper-plane mr-2"></i>
                                            Gửi yêu cầu
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div
                                class="card bg-base-100 shadow-2xl hover:shadow-3xl transition-all duration-300 hover:-translate-y-2 fade-in">
                                <div class="card-body">
                                    <h3 class="card-title mb-4">
                                        <i class="fas fa-clipboard-list mr-2"></i>
                                        Quy trình xử lý
                                    </h3>
                                    <div class="space-y-4">
                                        <div class="flex items-start">
                                            <div
                                                class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-1">
                                                1</div>
                                            <div>
                                                <h4 class="font-semibold">Xác minh báo cáo</h4>
                                                <p class="text-sm text-gray-600">Kiểm tra và xác nhận tính chính xác của
                                                    báo cáo</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div
                                                class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-1">
                                                2</div>
                                            <div>
                                                <h4 class="font-semibold">Thu thập bằng chứng</h4>
                                                <p class="text-sm text-gray-600">Tạo gói bằng chứng chi tiết và chuyên
                                                    nghiệp</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div
                                                class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-1">
                                                3</div>
                                            <div>
                                                <h4 class="font-semibold">Liên hệ nhà cung cấp</h4>
                                                <p class="text-sm text-gray-600">Gửi yêu cầu đến registrar và hosting
                                                    provider</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div
                                                class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-1">
                                                4</div>
                                            <div>
                                                <h4 class="font-semibold">Theo dõi kết quả</h4>
                                                <p class="text-sm text-gray-600">Cập nhật tiến độ và thông báo kết quả
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = Array.from(document.querySelectorAll('[data-tab-target]'));
            const panels = Array.from(document.querySelectorAll('[data-tab-panel]'));

            function activateTab(target) {
                // update buttons
                tabButtons.forEach(btn => {
                    const isActive = btn.getAttribute('data-tab-target') === target;
                    btn.classList.toggle('tab-active', isActive);
                    btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                });

                // update panels
                panels.forEach(panel => {
                    const show = panel.getAttribute('data-tab-panel') === target;
                    panel.classList.toggle('hidden', !show);
                    panel.setAttribute('aria-hidden', show ? 'false' : 'true');
                });
            }

            // click + keyboard handlers
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    activateTab(btn.getAttribute('data-tab-target'));
                    // optional: update url hash
                    history.replaceState(null, '', '#' + btn.getAttribute('data-tab-target'));
                });
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                    // Optional: left/right arrow navigation
                    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        const idx = tabButtons.indexOf(btn);
                        const nextIdx = (e.key === 'ArrowRight') ? (idx + 1) % tabButtons.length : (idx - 1 + tabButtons.length) % tabButtons.length;
                        tabButtons[nextIdx].focus();
                    }
                });
            });

            // Initial activation: prefer url hash -> tab-active in markup -> email for authenticated users -> first tab
            const hash = location.hash ? location.hash.substring(1) : null;
            const validTargets = tabButtons.map(b => b.getAttribute('data-tab-target'));
            if (hash && validTargets.includes(hash)) {
                activateTab(hash);
            } else {
                const initial = document.querySelector('.tab.tab-active[data-tab-target]');
                if (initial) {
                    activateTab(initial.getAttribute('data-tab-target'));
                } else {
                    // Default to email tab for authenticated users, otherwise first tab
                    {% if user.is_authenticated %}
                    activateTab('email');
                    {% else %}
                    activateTab(validTargets[0]);
                    {% endif %}
                }
            }
        });

        // simple placeholder for scanUrl (replace with your implementation)
        function scanUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                return alert('Please enter a URL to scan.');
            }
            // Replace this with your actual scan logic / API call
            alert('Scanning: ' + url + '\n(Replace this placeholder with real scan logic.)');
        }
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = Array.from(document.querySelectorAll('[data-tab-target]'));
            const panels = Array.from(document.querySelectorAll('[data-tab-panel]'));

            function activateTab(target) {
                // Update buttons
                tabButtons.forEach(btn => {
                    const isActive = btn.getAttribute('data-tab-target') === target;
                    btn.classList.toggle('tab-active', isActive);
                    btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                });

                // Update panels
                panels.forEach(panel => {
                    const show = panel.getAttribute('data-tab-panel') === target;
                    panel.classList.toggle('hidden', !show);
                    panel.setAttribute('aria-hidden', show ? 'false' : 'true');
                });
            }

            // Click handlers
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    activateTab(btn.getAttribute('data-tab-target'));
                });

                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        const idx = tabButtons.indexOf(btn);
                        const nextIdx = (e.key === 'ArrowRight') ? (idx + 1) % tabButtons.length : (idx - 1 + tabButtons.length) % tabButtons.length;
                        tabButtons[nextIdx].focus();
                    }
                });
            });

            // Initialize first tab: prefer email for authenticated users
            {% if user.is_authenticated %}
            activateTab('email');
            {% else %}
            activateTab('url');
            {% endif %}

            // Enter key support for inputs
            document.getElementById('urlInput')?.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    scanUrl();
                }
            });

            document.getElementById('emailContent')?.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    scanEmail();
                }
            });

            document.getElementById('domainInput')?.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    monitorDomain();
                }
            });
        });

        // URL Scanner Functions
        function setExample(url) {
            document.getElementById('urlInput').value = url;
        }

        function scanUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                showAlert('Vui lòng nhập URL cần quét!', 'warning');
                return;
            }

            if (!isValidUrl(url)) {
                showAlert('URL không hợp lệ! Vui lòng nhập URL đúng định dạng.', 'error');
                return;
            }

            showScanProgress();
            simulateScan(url);
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showScanProgress() {
            document.getElementById('scanProgress').classList.remove('hidden');
            document.getElementById('scanResults').classList.add('hidden');

            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('scanStatus');

            const steps = [
                { progress: 20, text: 'Đang kết nối đến URL...' },
                { progress: 40, text: 'Phân tích nội dung trang web...' },
                { progress: 60, text: 'Kiểm tra chứng chỉ SSL...' },
                { progress: 80, text: 'So sánh với cơ sở dữ liệu mối đe dọa...' },
                { progress: 100, text: 'Hoàn thành quét!' }
            ];

            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    progressBar.value = steps[currentStep].progress;
                    statusText.textContent = steps[currentStep].text;
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, 800);
        }

        function simulateScan(url) {
            setTimeout(() => {
                document.getElementById('scanProgress').classList.add('hidden');
                showScanResults(url);
            }, 4000);
        }

        function showScanResults(url) {
            const resultsDiv = document.getElementById('scanResults');
            const isSafe = Math.random() > 0.3; // 70% chance of being safe

            const resultClass = isSafe ? 'success' : 'error';
            const resultIcon = isSafe ? 'fa-check-circle' : 'fa-exclamation-triangle';
            const resultText = isSafe ? 'An toàn' : 'Nguy hiểm';
            const resultDesc = isSafe ? 'Không phát hiện mối đe dọa' : 'Phát hiện dấu hiệu lừa đảo';

            resultsDiv.innerHTML = `
                <div class="result-card">
                    <div class="alert alert-${resultClass} mb-6">
                        <i class="fas ${resultIcon} text-2xl"></i>
                        <div>
                            <h3 class="font-bold text-lg">${resultText}</h3>
                            <div class="text-sm">${resultDesc}</div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Thông tin cơ bản
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>URL:</span>
                                        <span class="font-mono text-xs break-all">${url}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Trạng thái:</span>
                                        <span class="badge badge-${resultClass}">${resultText}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Thời gian quét:</span>
                                        <span>${new Date().toLocaleString('vi-VN')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>SSL:</span>
                                        <span class="badge badge-success">Hợp lệ</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    Điểm số rủi ro
                                </h3>
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>Phishing</span>
                                            <span>${isSafe ? '5%' : '85%'}</span>
                                        </div>
                                        <progress class="progress progress-${isSafe ? 'success' : 'error'} w-full" value="${isSafe ? 5 : 85}" max="100"></progress>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>Malware</span>
                                            <span>${isSafe ? '2%' : '45%'}</span>
                                        </div>
                                        <progress class="progress progress-${isSafe ? 'success' : 'warning'} w-full" value="${isSafe ? 2 : 45}" max="100"></progress>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>Spam</span>
                                            <span>${isSafe ? '1%' : '30%'}</span>
                                        </div>
                                        <progress class="progress progress-${isSafe ? 'success' : 'warning'} w-full" value="${isSafe ? 1 : 30}" max="100"></progress>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button class="btn btn-outline" onclick="downloadReport()">
                            <i class="fas fa-download mr-2"></i>
                            Tải báo cáo
                        </button>
                        <button class="btn btn-outline" onclick="shareResult()">
                            <i class="fas fa-share mr-2"></i>
                            Chia sẻ
                        </button>
                        <button class="btn btn-primary" onclick="scanAgain()">
                            <i class="fas fa-redo mr-2"></i>
                            Quét lại
                        </button>
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        // Email Scanner Functions
        function scanEmail() {
            const content = document.getElementById('emailContent').value.trim();
            if (!content) {
                showAlert('Vui lòng nhập nội dung email!', 'warning');
                return;
            }
            showAlert('Đang quét email... Tính năng sẽ sớm được cập nhật!', 'info');
        }

        // Domain Monitor Functions
        function monitorDomain() {
            const domain = document.getElementById('domainInput').value.trim();
            if (!domain) {
                showAlert('Vui lòng nhập domain cần giám sát!', 'warning');
                return;
            }
            showAlert(`Đã thêm ${domain} vào danh sách giám sát!`, 'success');
        }

        // Takedown Functions
        function submitTakedown() {
            showAlert('Yêu cầu takedown đã được gửi! Chúng tôi sẽ xử lý trong 24h.', 'success');
        }

        // Utility Functions
        function downloadReport() {
            showAlert('Đang tạo báo cáo... Tính năng sẽ sớm được cập nhật!', 'info');
        }

        function shareResult() {
            if (navigator.share) {
                navigator.share({
                    title: 'Kết quả quét PhishingDetect',
                    text: 'Xem kết quả quét bảo mật từ PhishingDetect',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showAlert('Đã sao chép link vào clipboard!', 'success');
            }
        }

        function scanAgain() {
            document.getElementById('scanResults').classList.add('hidden');
            document.getElementById('urlInput').focus();
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} fixed top-4 right-4 w-auto max-w-md z-50 shadow-lg`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 4000);
        }
    </script>
</body>

{% endblock %}